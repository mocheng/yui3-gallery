YUI.add("gallery-comet-stream",function(c){var a={UNINITIALIZED:0,LOADING:1,LOADED:2,INTERACTIVE:3,COMPLETED:4};function b(e,d){c.Event.Target.call(this);this.url=e;this.cfg=c.merge({on:{},resetTimeout:300*1000,retryOnDisconnect:true,xhrPollingInterval:50},d);this._initStream();}b.prototype={_initStream:function(){var e,d=this;this._lastMsgIdx=0;if(c.UA.ie){this._createIFrame(this.url,function(f){if(d.cfg.on.pushed){d.cfg.on.pushed(f);}});}else{e=this.xhr=this._createXHR();e.onreadystatechange=function(){d._onXhrStreamStateChange();};e.open("GET",this.url,true);e.send();}this._streamStartTime=new Date();},_endStream:function(){if(this.transDoc){this.transDoc=null;}if(this._pollHandler){this._pollHandler.cancel();}if(this.xhr){var d=this.xhr;this.xhr=null;d.onreadystatechange=null;d.abort();}},_pollResponse:function(){this._parseResponse(this.xhr.responseText);},_onXhrStreamStateChange:function(){var g=this.xhr,d;if(!g){return;}try{d=g.status;}catch(f){}if(d===200){if(g.readyState===a.INTERACTIVE){if(c.UA.opera){this._pollHandler=c.later(this.cfg.xhrPollingInterval,this,this._pollResponse,null,true);}else{this._parseResponse(g.responseText);}}else{if(g.readyState===a.COMPLETED){if(c.UA.opera){this._pollResponse();}if(this.cfg.retryOnDisconnect){this._endStream();this._initStream();}}}}},_parseResponse:function(h){while(true){var j,g,k,d,i,e,f;d=this._lastMsgIdx;i=h.indexOf("\r\n",d);if(i==-1){break;}e=h.substring(d,i);f=Number("0x"+c.Lang.trim(e));if(window.isNaN(f)){this._endStream();throw new Error("wrong fomat");}g=i+2;k=g+f;if(k>h.length){break;}this._lastMsgIdx=k+2;j=h.substr(g,f);this._fireMessageEvent(j);}if((new Date()).getTime()-this._streamStartTime.getTime()>=this.cfg.resetTimeout){this._endStream();this._initStream();}},_fireMessageEvent:function(d){this.fire("comet:pushed",d);if(this.cfg.on.pushed){this.cfg.on.pushed(d);}},_createIFrame:function(e,f){this.transDoc=new window.ActiveXObject("htmlfile");this.transDoc.open();if(e.match(/^http.?:\/\/([^\/]+)\/?/)[1]!==window.document.domain){this.transDoc.write('<html><script type="text/javascript">document.domain="'+window.document.domain+'";<\/script></html>');}this.transDoc.write("<html></html>");this.transDoc.close();this.transDoc.parentWindow.callback=f;this.transDoc.parentWindow.mo="mo";var d=this.transDoc.createElement("div");this.transDoc.body.appendChild(d);d.innerHTML='<iframe src="'+e+'"></iframe>';},_createXHR:function(){var d=null;if(window.XMLHttpRequest){d=new XMLHttpRequest();}else{if(window.ActiveXObject){try{d=new window.ActiveXObject("Msxml2.XMLHTTP");}catch(f){try{d=new window.ActiveXObject("Microsoft.XMLHTTP");}catch(e){d=null;}}}}if(!d){throw new Error("XMLHttpRequest is not supported");}return d;}};c.extend(b,c.Event.Target,b.prototype);c.CometStream=b;},"@VERSION@",{requires:["event-base","event-custom"]});