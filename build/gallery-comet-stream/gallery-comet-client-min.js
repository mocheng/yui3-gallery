YUI.add("gallery-comet-client",function(a){function b(d,c){a.Event.Target.call(this);this.url=d;this.cfg=a.merge({on:{},resetTimeout:300*1000,xhrPollingInterval:150},c);this._initStream();}b.prototype={_initStream:function(){var d,c=this;this._lastMsgIdx=0;if(a.UA.ie){this._createIFrame(this.url,function(e){if(c.cfg.on.pushed){c.cfg.on.pushed(e);}});}else{d=this.xhr=this._createXHR();d.onreadystatechange=function(){c._onXhrStreamStateChange();};d.open("GET",this.url,true);d.send();}this._streamStartTime=new Date();},_endStream:function(){if(window.opera){window.opera.postError("_endStream");return;}if(this.transDoc){this.transDoc=null;}if(this._pollHandler){this._pollHandler.cancel();}if(this.xhr){var c=this.xhr;this.xhr=null;c.onreadystatechange=null;c.abort();}},_pollResponse:function(){this._parseResponse(this.xhr.responseText);},_onXhrStreamStateChange:function(){var c=this.xhr;if(!c){return;}if(c.status===200){if(c.readyState===3){if(a.UA.opera){this._pollHandler=a.later(this.cfg.xhrPollingInterval,this,this._pollResponse,null,true);}else{this._parseResponse(c.responseText);}}else{if(c.readyState===4){if(a.UA.opera){this._pollResponse();}this._endStream();this._initStream();}}}},_parseResponse:function(g){while(true){var i,f,j,c,h,d,e;c=this._lastMsgIdx;h=g.indexOf("\r\n",c);if(h==-1){break;}d=g.substring(c,h);e=Number("0x"+a.Lang.trim(d));if(window.isNaN(e)){throw new Error("wrong fomat");}f=h+2;j=f+e;if(j>g.length){break;}this._lastMsgIdx=j+2;i=g.substr(f,e);this._fireMessageEvent(i);}if((new Date()).getTime()-this._streamStartTime.getTime()>=this.cfg.resetTimeout){this._endStream();this._initStream();}},_fireMessageEvent:function(c){this.fire("comet:pushed",c);if(this.cfg.on.pushed){this.cfg.on.pushed(c);}},_createIFrame:function(d,e){this.transDoc=new window.ActiveXObject("htmlfile");this.transDoc.open();if(d.match(/^http.?:\/\/([^\/]+)\/?/)[1]!==window.document.domain){this.transDoc.write('<html><script type="text/javascript">document.domain="'+window.document.domain+'";<\/script></html>');}this.transDoc.write("<html></html>");this.transDoc.close();this.transDoc.parentWindow.callback=e;this.transDoc.parentWindow.mo="mo";var c=this.transDoc.createElement("div");this.transDoc.body.appendChild(c);c.innerHTML='<iframe src="'+d+'"></iframe>';},_createXHR:function(){var c=null;if(window.XMLHttpRequest){c=new XMLHttpRequest();}else{if(window.ActiveXObject){try{c=new window.ActiveXObject("Msxml2.XMLHTTP");}catch(e){try{c=new window.ActiveXObject("Microsoft.XMLHTTP");}catch(d){c=null;}}}}if(!c){throw new Error("XMLHttpRequest is not supported");}return c;}};a.extend(b,a.Event.Target,b.prototype);a.CometClient=b;},"@VERSION@",{requires:["event-base","event-custom"]});